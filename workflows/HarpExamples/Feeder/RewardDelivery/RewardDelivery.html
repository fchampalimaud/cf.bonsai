<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Reward Delivery | CF.Bonsai </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Reward Delivery | CF.Bonsai ">
      
      
      <link rel="icon" href="../../../../images/logo.svg">
      <link rel="stylesheet" href="../../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../../public/main.css">
      <meta name="docfx:navrel" content="">
      <meta name="docfx:tocrel" content="../../../../articles/toc.html">
      
      <meta name="docfx:rel" content="../../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/fchampalimaud/cf.bonsai/blob/main/docs/workflows/HarpExamples/Feeder/RewardDelivery/RewardDelivery.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../../index.html">
            <img id="logo" class="svg" src="../../../../images/logo_white.svg" alt="CF.Bonsai">
            CF.Bonsai
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="reward-delivery">Reward Delivery</h1>

<h2 id="summary">Summary</h2>
<p>This example demonstrates how to give a reward with a feeder. An example of an automatic feeder can be found <a href="https://www.cf-hw.org/open-source-tools/tools/fish-feeder">here</a>.
The feeders use the same board as the <a href="https://harp-tech.org/api/Harp.SyringePump.html">Harp SyringePump</a>.
For this example, it is assumed that the feeder is using a disk with 40 equally spaced reward positions.</p>
<h2 id="workflow">Workflow</h2>
<div class="workflow"><p><img src="RewardDelivery.bonsai" alt="Example"></p>
</div>
<h2 id="details">Details</h2>
<ol>
<li>Initializes the needed variables/subjects (UpdateStep, StepNumber, NumberOfSteps).</li>
<li>Establishes the commands to be sent to the SyringePump board and publishes all the events from the device. The PortName property in the SyringePump node needs to be set to the COM device on the computer. To create the subject node, right-click on the SyringePump node -&gt; Create Source -&gt; Behavior Subject, and name it accordingly.</li>
<li>Sets the SyringePump protocol direction to <code>Forward</code>.</li>
<li>Sets the number of steps of the SyringePump protocol. The number of steps changes according to 9. and 10. to compensate for the fact that the board doesn't accept non-integer number of steps.</li>
<li>Sets the step period to 10 ms (default value).</li>
<li>Sets the step mode to quarter-step. Feel free to try other step modes, but remember to change the number of steps accordingly if you intend to keep the same amount of rotation degrees.</li>
<li>Ensures that command messages are sent only when the device is ready.</li>
<li>Gives a reward when <code>A</code> is pressed.
<ol>
<li>Enables the motor.</li>
<li>Executes the SyringePump protocol.</li>
<li>Disables the motor.</li>
</ol>
</li>
<li>Updates the StepNumber Behavior Subject every time a reward is given. If the current StepNumber is equal to 5 it updates to 1, otherwise it adds 1 to the current value.</li>
<li>Updates the NumberOfSteps Behavior Subject (which in turn updates the protocol step count) according to the current StepNumber. If StepNumber is less than 4, the NumberOfSteps is set to 104, otherwise it is set to 103.</li>
</ol>
<h2 id="requirements">Requirements</h2>
<p>This example requires the following Bonsai packages:</p>
<ul>
<li>Harp - SyringePump (from nuget.org)</li>
</ul>
<h2 id="how-to-calculate-the-needed-number-of-steps-per-reward">How to calculate the needed number of steps per reward</h2>
<p>In the <a href="#details">Details</a> section, the fact that the number of steps per protocol is either 103 or 104 seems arbitrary, but there's a reason for it. This section aims to address how one can calculate the needed number of steps to deliver consecutive rewards that are equally spaced in the circular mechanism.</p>
<p>For the case presented above, we know that there are 40 possible reward positions. The angle that separates 2 consecutive rewards is given by:</p>
<p><span class="math">\(\frac{360\degree}{40} = 9\degree\)</span></p>
<p>So every time a SyringePump protocol is executed, the mechanism should advance <span class="math">\(9\degree\)</span>. To convert this value to motor steps, one has to divide it by the amount of degrees that a motor step is equivalent to. For the feeder's motor, each motor step is equivalent to <span class="math">\(1.8\degree\)</span>. However, the motor has an internal gear so that in order for the shaft to make a full rotation it's necessary that the motor fully rotates 5.18 times. With this in mind, it's now possible to calculate the number of full-steps needed for the shaft to move <span class="math">\(9\degree\)</span>:</p>
<p><span class="math">\(\frac{9\degree}{\frac{1.8\degree}{5.18}} = \frac{9\degree \times 5.18}{1.8\degree} = 25.9 \text{ steps}\)</span></p>
<p>Then, since the stepper motor has different micro steps (or step modes), such has half-steps or quarter-steps, there's a need to multiple the previous result with the respective micro step multiplier.</p>
<ul>
<li>Full-step: x1</li>
<li>Half-step: x2</li>
<li>Quarter-step: x4</li>
<li>Eighth-step: x8</li>
<li>Sixteenth-step: x16</li>
</ul>
<p>Since the example above uses quarter-step, we get:</p>
<p><span class="math">\(25.9 \times 4 = 103.6 \text{ quarter-steps}\)</span></p>
<p>Finally, as mentioned before, it is not possible to execute SyringePump protocols with non-integer number of steps. If one decides to just round the result either up or down, it will cause a cumulative displacement error of the disk in the long term. For this example, this cumulative displacement error can be completely corrected by executing 2 protocols with 103 steps every 5 protocols and the remaining 3 out of 5 protocols with 104 steps (because <span class="math">\(103.6 \times 5 = 103 \times 2 + 104 \times 3 = 518 \text{ steps}\)</span>).</p>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/fchampalimaud/cf.bonsai/blob/main/docs/workflows/HarpExamples/Feeder/RewardDelivery/RewardDelivery.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>&copy; 2024 Champalimaud Foundation and Contributors</span> -<span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
